{"ast":null,"code":"//https://www.youtube.com/watch?v=-qQjyxbla-k\n//--------https://www.youtube.com/watch?v=t2LvPXHLrek\n//https://www.youtube.com/watch?v=t2LvPXHLrek&t=1s\nconst nodemailer = require(\"nodemailer\"); //https://mailtrap.io/inboxes/2499902/messages/3867662540\n\n\nimport { fetchallemails } from \"../../../lib/db\";\nimport { getSession } from \"next-auth/client\";\nexport default async function handler(req, res) {\n  if (req.method !== \"POST\") {\n    return res.status(405).json({\n      error: \"Method Not Allowed\"\n    });\n  }\n\n  const {\n    subject,\n    message\n  } = req.body;\n  const session = await getSession({\n    req: req\n  });\n  const emailsender = session.user.email;\n\n  if (!subject || !message) {\n    return res.status(400).json({\n      error: \"Missing required parameters\"\n    });\n  }\n\n  const transporter = nodemailer.createTransport({\n    port: process.env.smtp_port,\n    secure: false,\n    host: process.env.smtp_host,\n    auth: {\n      user: process.env.smtp_user,\n      pass: process.env.smtp_pass\n    }\n  });\n  const to = (await fetchallemails()).map(user => user.email); // Set up email options\n\n  const mailOptions = {\n    from: emailsender,\n    to,\n    subject: subject,\n    text: message\n  };\n\n  try {\n    const info = await transporter.sendMail(mailOptions);\n    console.log(\"Email sent: \");\n    res.status(200).json({\n      success: true\n    });\n  } catch (error) {\n    console.error(error);\n    res.status(500).json({\n      error: \"Internal Server Error\"\n    });\n  }\n}","map":null,"metadata":{},"sourceType":"module"}